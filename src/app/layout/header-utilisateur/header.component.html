<mat-sidenav-container class="sidenav-container">
  <!-- SIDENAV -->
  <mat-sidenav
    #drawer
    [mode]="isMobile ? 'over' : 'side'"
    [opened]="!isMobile"
    class="sidenav"
    fixedInViewport
    (opened)="onDrawerOpened()"
    (closedStart)="onDrawerClosed()"
  >
    <div class="sidenav-header">
      <div class="user-info">
        <div class="avatar-container">
          <span class="avatar" *ngIf="!avatarUrl">{{ initials }}</span>
          <img *ngIf="avatarUrl"
               [src]="avatarUrl"
               alt="Avatar utilisateur"
               class="avatar-img" />
        </div>
        <div class="user-details">
          <div class="user-name">
            {{ user?.prenomUtilisateur }} {{ user?.nomUtilisateur }}
          </div>
          <div class="user-role">{{ getRoleText(role) }}</div>
        </div>
      </div>
    </div>

    <mat-nav-list class="nav-list">
      <div class="logo-container">
        <a class="logo"
           [routerLink]="'/accueil'"
           (click)="closeDrawer(drawer)"
           aria-label="Retour à l'accueil">
          <img src="assets/images/logo.png"
               alt="PapouService Logo"
               class="logo-img" />
          <span class="logo-text">PapouService</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="section-label">Navigation</div>
        <ng-container [ngSwitch]="role">
          <!-- ADMIN -->
          <ng-container *ngSwitchCase="'ADMIN'">
            <a mat-list-item
               routerLink="/admin/dashboard"
               [class.active]="isActive('/admin/dashboard')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/dashboard') ? 'page' : null">
              <mat-icon class="nav-icon">dashboard</mat-icon>
              <span class="nav-text">Dashboard</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/admin/clients"
               [class.active]="isActive('/admin/clients')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/clients') ? 'page' : null">
              <mat-icon class="nav-icon">people</mat-icon>
              <span class="nav-text">Clients</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/admin/transactions"
               [class.active]="isActive('/admin/transactions')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/transactions') ? 'page' : null">
              <mat-icon class="nav-icon">account_balance_wallet</mat-icon>
              <span class="nav-text">Transactions</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/admin/administrateurs"
               [class.active]="isActive('/admin/administrateurs')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/administrateurs') ? 'page' : null">
              <mat-icon class="nav-icon">admin_panel_settings</mat-icon>
              <span class="nav-text">Administrateurs</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/admin/annonces"
               [class.active]="isActive('/admin/annonces')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/annonces') ? 'page' : null">
              <mat-icon class="nav-icon">campaign</mat-icon>
              <span class="nav-text">Annonces</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/admin/pubs"
               [class.active]="isActive('/admin/pubs')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/admin/pubs') ? 'page' : null">
              <mat-icon class="nav-icon">ads_click</mat-icon>
              <span class="nav-text">Publicités</span>
              <div class="nav-indicator"></div>
            </a>
          </ng-container>

          <!-- USER -->
          <ng-container *ngSwitchCase="'USER'">
            <a mat-list-item
               routerLink="/user/profil"
               [class.active]="isActive('/user/profil')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/user/profil') ? 'page' : null">
              <mat-icon class="nav-icon">person</mat-icon>
              <span class="nav-text">Mon profil</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/user/depot"
               [class.active]="isActive('/user/depot')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/user/depot') ? 'page' : null">
              <mat-icon class="nav-icon">payments</mat-icon>
              <span class="nav-text">Faire un Dépôt</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/user/retrait"
               [class.active]="isActive('/user/retrait')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/user/retrait') ? 'page' : null">
              <mat-icon class="nav-icon">savings</mat-icon>
              <span class="nav-text">Faire un Retrait</span>
              <div class="nav-indicator"></div>
            </a>

            <a mat-list-item
               routerLink="/user/historique"
               [class.active]="isActive('/user/historique')"
               (click)="closeDrawer(drawer)"
               [attr.aria-current]="isActive('/user/historique') ? 'page' : null">
              <mat-icon class="nav-icon">history</mat-icon>
              <span class="nav-text">Historique</span>
              <div class="nav-indicator"></div>
            </a>
          </ng-container>
        </ng-container>
      </div>

      <div class="nav-section">
        <div class="section-label">Paramètres</div>
        <a mat-list-item
           [routerLink]="role === 'ADMIN' ? '/admin/mot-de-passe' : '/user/mot-de-passe'"
           [class.active]="isActive('/admin/mot-de-passe') || isActive('/user/mot-de-passe')"
           (click)="closeDrawer(drawer)"
           [attr.aria-current]="(isActive('/admin/mot-de-passe') || isActive('/user/mot-de-passe')) ? 'page' : null">
          <mat-icon class="nav-icon">lock</mat-icon>
          <span class="nav-text">Changer mot de passe</span>
          <div class="nav-indicator"></div>
        </a>
      </div>

      <div class="nav-section logout-section">
        <a mat-list-item
           (click)="logout(); closeDrawer(drawer)"
           class="logout-item">
          <mat-icon class="nav-icon">logout</mat-icon>
          <span class="nav-text">Déconnexion</span>
          <div class="nav-indicator"></div>
        </a>
      </div>
    </mat-nav-list>
  </mat-sidenav>

  <!-- CONTENU -->
  <mat-sidenav-content>
    <mat-toolbar class="topbar">
      <button mat-icon-button
              (click)="drawer.toggle()"
              *ngIf="isMobile"
              class="menu-toggle"
              aria-label="Ouvrir le menu">
        <mat-icon>menu</mat-icon>
      </button>

      <a class="toolbar-title"
         [routerLink]="homeRoute"
         (click)="closeDrawer(drawer)"
         aria-label="Retour à l'accueil">
        <img src="assets/images/logo.png"
             alt="PapouService Logo"
             class="header-logo" />
        <span class="title-text">PapouService</span>
      </a>

      <span class="spacer"></span>

      <!-- Indicateur de rôle -->
      <div class="role-badge" *ngIf="role">
        <mat-icon class="badge-icon">
          {{ role === 'ADMIN' ? 'admin_panel_settings' : 'person' }}
        </mat-icon>
        <span class="badge-text">{{ getRoleText(role) }}</span>
      </div>

      <!-- Avatar + menu utilisateur -->
      <button mat-button
              class="user-chip"
              [matMenuTriggerFor]="accountMenu"
              aria-label="Menu utilisateur">
        <div class="avatar-container">
          <span class="avatar" *ngIf="!avatarUrl">{{ initials }}</span>
          <img *ngIf="avatarUrl"
               [src]="avatarUrl"
               alt="Avatar utilisateur"
               class="avatar-img" />
        </div>
        <div class="user-info">
          <span class="user-name">
            {{ user?.prenomUtilisateur }} {{ user?.nomUtilisateur }}
          </span>
          <span class="user-email">
            {{ user?.email }}
          </span>
        </div>
        <mat-icon class="expand-icon">expand_more</mat-icon>
      </button>

      <mat-menu #accountMenu="matMenu"
                class="account-menu"
                xPosition="before"
                yPosition="below">
        <div class="menu-header">
          <div class="menu-user-info">
            <div class="avatar-container small">
              <span class="avatar" *ngIf="!avatarUrl">{{ initials }}</span>
              <img *ngIf="avatarUrl"
                   [src]="avatarUrl"
                   alt="Avatar utilisateur"
                   class="avatar-img" />
            </div>
            <div class="user-details">
              <div class="user-name">
                {{ user?.prenomUtilisateur }} {{ user?.nomUtilisateur }}
              </div>
              <div class="user-email">
                {{ user?.email }}
              </div>
              <div class="user-role">
                {{ getRoleText(role) }}
              </div>
            </div>
          </div>
        </div>

        <button mat-menu-item
                (click)="menuNavigate(homeRoute); accountMenu.closed.emit()"
                class="menu-item">
          <mat-icon>home</mat-icon>
          <span>Mon espace</span>
        </button>

        <button mat-menu-item
                (click)="menuNavigate('/user/profil'); accountMenu.closed.emit()"
                class="menu-item">
          <mat-icon>person</mat-icon>
          <span>Mon profil</span>
        </button>

        <button mat-menu-item
                (click)="menuNavigate(role === 'ADMIN' ? '/admin/mot-de-passe' : '/user/mot-de-passe'); accountMenu.closed.emit()"
                class="menu-item">
          <mat-icon>lock</mat-icon>
          <span>Changer mot de passe</span>
        </button>

        <div class="menu-divider"></div>

        <button mat-menu-item
                (click)="logout(); accountMenu.closed.emit()"
                class="menu-item logout">
          <mat-icon>logout</mat-icon>
          <span>Déconnexion</span>
        </button>
      </mat-menu>
    </mat-toolbar>

    <div class="sidenav-content-body">
      <router-outlet></router-outlet>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
