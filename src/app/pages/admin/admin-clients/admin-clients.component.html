<div class="admin-clients">
  <!-- Header -->
  <div class="header-row">
    <div class="header-content">
      <h2>üë• Gestion des Clients</h2>
      <div class="tools">
        <button mat-stroked-button (click)="loadClientsData()" [disabled]="loading" class="refresh-btn">
          <mat-icon>refresh</mat-icon>
          {{ loading ? 'Actualisation...' : 'Actualiser' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="state" *ngIf="loading">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <span>Chargement des donn√©es clients...</span>
    </div>
  </div>

  <ng-container *ngIf="!loading">
    <!-- Stats Cards -->
    <div class="stat-cards">
      <mat-card class="stat-card primary">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-label">Total Clients</div>
          <div class="stat-value">{{ totalClients }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card accent">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-content">
          <div class="stat-label">Clients Fid√®les</div>
          <div class="stat-value">{{ fideleClients }}</div>
        </div>
      </mat-card>

      <mat-card class="stat-card warn">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-label">Niveau Moyen</div>
          <div class="stat-value">
            {{ getAverageStars() }}‚≠ê
          </div>
        </div>
      </mat-card>
    </div>

    <!-- Analytics Section -->
    <div class="analytics-section">
      <div class="chart-card">
        <h3>üìà R√©partition par Niveau de Fid√©lit√©</h3>
        <div class="chart-container">
          <canvas baseChart
                  [data]="chartDataConfig"
                  [options]="chartOptions"
                  [type]="chartType">
          </canvas>
        </div>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filter-bar">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Rechercher un client</mat-label>
          <input matInput
                 [(ngModel)]="search"
                 (ngModelChange)="applyFilter()"
                 placeholder="Nom, pr√©nom ou num√©ro"
                 [disabled]="loading">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Niveau de fid√©lit√©</mat-label>
          <mat-select [(value)]="selectedStarFilter" (selectionChange)="applyFilter()" [disabled]="loading">
            <mat-option value="">Tous les niveaux</mat-option>
            <mat-option *ngFor="let star of [0,1,2,3,4,5]" [value]="star.toString()">
              {{ star }} ‚≠ê
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-stroked-button (click)="resetFilter()" class="reset-btn" [disabled]="loading">
          <mat-icon>clear_all</mat-icon>
          R√©initialiser
        </button>
      </div>

      <div class="results-info">
        <span class="results-count">{{ dataSource.filteredData.length }} client(s) trouv√©(s)</span>
        <span class="loading-text" *ngIf="loading">(Mise √† jour...)</span>
      </div>
    </div>

    <!-- Clients Table -->
    <div class="table-section">
      <div *ngIf="dataSource.filteredData.length === 0 && !loading" class="no-data">
        <div class="no-data-icon">üîç</div>
        <h4>Aucun client trouv√©</h4>
        <p>Aucun client ne correspond √† vos crit√®res de recherche</p>
        <button mat-raised-button color="primary" (click)="resetFilter()" class="retry-btn">
          <mat-icon>refresh</mat-icon>
          R√©initialiser les filtres
        </button>
      </div>

      <!-- Desktop View -->
      <div class="desktop-view" *ngIf="dataSource.filteredData.length > 0">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
            <!-- Pr√©nom Column -->
            <ng-container matColumnDef="prenom">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Pr√©nom</th>
              <td mat-cell *matCellDef="let client">
                <div class="client-name">
                  <span class="name">{{ client.prenomUtilisateur || 'Non renseign√©' }}</span>
                  <span class="activity"
                        [style.color]="getActivityColor(client.lastActivity)"
                        [matTooltip]="activityTooltip(client.lastActivity)">
                    {{ getActivityBadge(client.lastActivity) }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Nom Column -->
            <ng-container matColumnDef="nom">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
              <td mat-cell *matCellDef="let client">{{ client.nomUtilisateur || 'Non renseign√©' }}</td>
            </ng-container>

            <!-- Num√©ro Column -->
            <ng-container matColumnDef="numero">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Num√©ro</th>
              <td mat-cell *matCellDef="let client" class="phone-cell">
                <mat-icon class="phone-icon">phone</mat-icon>
                {{ client.numeroUtilisateur || 'Non renseign√©' }}
              </td>
            </ng-container>

            <!-- Stats Column -->
            <ng-container matColumnDef="stats">
              <th mat-header-cell *matHeaderCellDef>Activit√©</th>
              <td mat-cell *matCellDef="let client" class="stats-cell">
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-label">D√©p√¥ts</span>
                    <span class="stat-value">{{ client.depotCount || 0 }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Retraits</span>
                    <span class="stat-value">{{ client.retraitCount || 0 }}</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-label">Total</span>
                    <span class="stat-value total">{{ getTotalAmount(client) | number }} FCFA</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Fid√©lit√© Column -->
            <ng-container matColumnDef="fidelity">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fid√©lit√©</th>
              <td mat-cell *matCellDef="let client">
                <div class="fidelity-display">
                  <span class="stars" [class.fidele]="client.isFidele" [matTooltip]="'Niveau ' + client.stars + ' √©toiles'">
                    {{ client.fidelityStars }}
                  </span>
                  <span *ngIf="client.isFidele" class="fidele-badge" matTooltip="Client fid√®le üéñ">
                    üéñ Fid√®le
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let client">
                <div class="action-buttons">
                  <button mat-raised-button color="primary" class="action-btn"
                          (click)="voirProfil(client.idUtilisateur)"
                          [disabled]="loading"
                          matTooltip="Voir le profil du client">
                    <mat-icon>person</mat-icon>
                    Profil
                  </button>
                  <button mat-raised-button color="accent" class="action-btn"
                          (click)="voirHistorique(client.idUtilisateur)"
                          [disabled]="loading"
                          matTooltip="Voir l'historique des transactions">
                    <mat-icon>history</mat-icon>
                    Historique
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </div>

      <!-- Mobile View -->
      <div class="mobile-view" *ngIf="dataSource.filteredData.length > 0">
        <div *ngFor="let client of dataSource.filteredData" class="client-card">
          <div class="card-header">
            <div class="client-info">
              <h4>{{ client.prenomUtilisateur }} {{ client.nomUtilisateur }}</h4>
              <div class="client-meta">
                <span class="phone">
                  <mat-icon>phone</mat-icon>
                  {{ client.numeroUtilisateur }}
                </span>
                <span class="activity" [style.color]="getActivityColor(client.lastActivity)"
                      [matTooltip]="'Derni√®re activit√©: ' + (client.lastActivity ? formatDate(client.lastActivity) : 'Inconnue')">
                  {{ getActivityBadge(client.lastActivity) }}
                </span>
              </div>
            </div>
            <div class="fidelity-mobile">
              <span class="stars" [class.fidele]="client.isFidele" [matTooltip]="'Niveau ' + client.stars + ' √©toiles'">
                {{ client.fidelityStars }}
              </span>
              <span *ngIf="client.isFidele" class="fidele-badge" matTooltip="Client fid√®le">üéñ</span>
            </div>
          </div>

          <div class="card-stats">
            <div class="stat-row">
              <div class="stat">
                <span class="label">D√©p√¥ts</span>
                <span class="value">{{ client.depotCount }}</span>
              </div>
              <div class="stat">
                <span class="label">Retraits</span>
                <span class="value">{{ client.retraitCount }}</span>
              </div>
              <div class="stat">
                <span class="label">Total</span>
                <span class="value total">{{ getTotalAmount(client) | number }} FCFA</span>
              </div>
            </div>
          </div>

          <div class="card-actions">
            <button mat-stroked-button color="primary" class="action-btn-mobile"
                    (click)="voirProfil(client.idUtilisateur)"
                    [disabled]="loading">
              <mat-icon>person</mat-icon>
              Profil
            </button>
            <button mat-stroked-button color="accent" class="action-btn-mobile"
                    (click)="voirHistorique(client.idUtilisateur)"
                    [disabled]="loading">
              <mat-icon>history</mat-icon>
              Historique
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <mat-paginator *ngIf="dataSource.filteredData.length > 0"
                    [pageSizeOptions]="[10, 25, 50]"
                    [pageSize]="10"
                    showFirstLastButtons
                    [length]="dataSource.filteredData.length"
                    class="custom-paginator"
                    [disabled]="loading">
      </mat-paginator>
    </div>
  </ng-container>
</div>
