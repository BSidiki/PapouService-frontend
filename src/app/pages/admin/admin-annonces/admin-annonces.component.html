<div class="admin-annonces">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <h2>üì∞ Gestion des Annonces</h2>
      <div class="header-actions">
        <button mat-stroked-button (click)="load()" [disabled]="loading" class="refresh-btn">
          <mat-icon>refresh</mat-icon>
          {{ loading ? 'Actualisation...' : 'Actualiser' }}
        </button>
      </div>
    </div>
    <p class="subtitle">Cr√©ez et g√©rez les annonces affich√©es aux utilisateurs</p>
  </div>

  <!-- Stats Cards -->
  <div class="stats-cards" *ngIf="!loading">
    <div class="stat-card primary">
      <div class="stat-icon">üì¢</div>
      <div class="stat-content">
        <div class="stat-value">{{ dataSource.data.length }}</div>
        <div class="stat-label">Annonces</div>
      </div>
    </div>
    <div class="stat-card accent">
      <div class="stat-icon">üñºÔ∏è</div>
      <div class="stat-content">
        <div class="stat-value">{{ getAnnoncesWithImages() }}</div>
        <div class="stat-label">Avec images</div>
      </div>
    </div>
  </div>

  <!-- Form Section -->
  <div class="form-section">
    <mat-card class="form-card">
      <div class="card-header">
        <h3>{{ isEditing ? '‚úèÔ∏è Modifier l\'Annonce' : '‚ûï Cr√©er une Annonce' }}</h3>
        <span class="form-subtitle">
          {{ isEditing ? 'Modifiez les informations de l\'annonce' : 'Remplissez les champs pour cr√©er une nouvelle annonce' }}
        </span>
      </div>

      <form (ngSubmit)="submit()" [formGroup]="form" enctype="multipart/form-data" class="annonce-form">
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Titre de l'annonce</mat-label>
            <input matInput formControlName="titre" placeholder="Ex: Nouvelle fonctionnalit√© disponible" />
            <mat-icon matSuffix>title</mat-icon>
            <mat-error *ngIf="form.get('titre')?.hasError('required')">
              Le titre est requis
            </mat-error>
            <mat-error *ngIf="form.get('titre')?.hasError('maxlength')">
              Maximum 200 caract√®res
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Contenu de l'annonce</mat-label>
            <textarea matInput
                     rows="4"
                     formControlName="texte"
                     placeholder="D√©crivez le contenu de votre annonce..."></textarea>
            <mat-icon matSuffix>description</mat-icon>
            <mat-error *ngIf="form.get('texte')?.hasError('required')">
              Le contenu est requis
            </mat-error>
            <mat-error *ngIf="form.get('texte')?.hasError('maxlength')">
              Maximum 4000 caract√®res
            </mat-error>
            <mat-hint>{{ form.get('texte')?.value?.length || 0 }}/4000 caract√®res</mat-hint>
          </mat-form-field>

          <div class="file-upload-section full-width">
            <label class="upload-label">Image de l'annonce</label>
            <div class="upload-container">
              <input type="file"
                     id="mediaUpload"
                     accept="image/*"
                     (change)="onFileSelected($event)"
                     class="file-input" />
              <label for="mediaUpload" class="upload-button">
                <mat-icon>cloud_upload</mat-icon>
                <span>{{ selectedFile ? selectedFile.name : 'Choisir une image' }}</span>
              </label>

              <div class="file-preview" *ngIf="selectedFile || (isEditing && editingAnnonce?.media)">
                <img [src]="getPreviewImage()"
                     (click)="openImageZoom(getPreviewImage())"
                     class="preview-image"
                     alt="Aper√ßu de l'image" />
                <button type="button"
                        mat-icon-button
                        color="warn"
                        class="remove-image"
                        (click)="removeImage()"
                        matTooltip="Supprimer l'image">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <div class="upload-hint" *ngIf="!selectedFile && !(isEditing && editingAnnonce?.media)">
                <mat-icon>info</mat-icon>
                <span>Formats support√©s: JPG, PNG, GIF ‚Ä¢ Taille max: 5MB</span>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <div class="form-meta">
            <span class="timestamp">
              <mat-icon>schedule</mat-icon>
              Cr√©√© le {{ nowLabel() }}
            </span>
          </div>

          <div class="action-buttons">
            <button mat-stroked-button
                    type="button"
                    (click)="cancelEdit()"
                    *ngIf="isEditing"
                    class="cancel-btn">
              <mat-icon>cancel</mat-icon>
              Annuler
            </button>
            <button mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="form.invalid || loading"
                    class="submit-btn">
              <div class="button-content">
                <mat-progress-spinner
                  *ngIf="loading"
                  diameter="20"
                  mode="indeterminate"
                  color="accent">
                </mat-progress-spinner>
                <mat-icon *ngIf="!loading">{{ isEditing ? 'save' : 'add' }}</mat-icon>
                <span>{{ loading ? 'Traitement...' : (isEditing ? 'Modifier l\'annonce' : 'Cr√©er l\'annonce') }}</span>
              </div>
            </button>
          </div>
        </div>
      </form>
    </mat-card>
  </div>

  <!-- List Section -->
  <div class="list-section">
    <mat-card class="list-card">
      <div class="list-header">
        <div class="list-title">
          <h3>üìã Liste des Annonces</h3>
          <span class="list-subtitle">{{ dataSource.filteredData.length }} annonce(s) trouv√©e(s)</span>
        </div>

        <div class="list-actions">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Rechercher une annonce</mat-label>
            <input matInput
                   [(ngModel)]="search"
                   (ngModelChange)="applyFilter()"
                   placeholder="Titre ou contenu..." />
            <mat-icon matSuffix>search</mat-icon>
            <button *ngIf="search"
                    mat-icon-button
                    matSuffix
                    aria-label="Effacer"
                    (click)="search=''; applySearch()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading">
        <div class="loading-content">
          <mat-spinner diameter="40"></mat-spinner>
          <span>Chargement des annonces...</span>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="table-section" *ngIf="!loading && dataSource.filteredData.length > 0">
        <div class="desktop-view">
          <div class="table-container">
            <table mat-table [dataSource]="dataSource" matSort class="annonces-table">

              <!-- Image Column -->
              <ng-container matColumnDef="media">
                <th mat-header-cell *matHeaderCellDef>Image</th>
                <td mat-cell *matCellDef="let annonce">
                  <div class="image-cell" *ngIf="annonce.media">
                    <img [src]="toBase64(annonce.media)"
                         (click)="openImageZoom(toBase64(annonce.media))"
                         class="annonce-image"
                         alt="Image annonce"
                         matTooltip="Cliquer pour zoomer" />
                    <span class="image-hover">üîç</span>
                  </div>
                  <div class="no-image" *ngIf="!annonce.media">
                    <mat-icon>image_not_supported</mat-icon>
                    <span>Aucune image</span>
                  </div>
                </td>
              </ng-container>

              <!-- Titre Column -->
              <ng-container matColumnDef="titre">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Titre</th>
                <td mat-cell *matCellDef="let annonce">
                  <div class="annonce-title">
                    <span class="title-text">{{ annonce.titre }}</span>
                    <span class="title-badge" *ngIf="!annonce.media">üìù Texte</span>
                  </div>
                </td>
              </ng-container>

              <!-- Texte Column -->
              <ng-container matColumnDef="texte">
                <th mat-header-cell *matHeaderCellDef>Contenu</th>
                <td mat-cell *matCellDef="let annonce">
                  <div class="annonce-content">
                    {{ annonce.texte.length > 100 ? (annonce.texte | slice:0:100) + '...' : annonce.texte }}
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let annonce">
                  <div class="action-buttons">
                    <button mat-raised-button
                            color="primary"
                            (click)="startEdit(annonce)"
                            class="edit-btn"
                            matTooltip="Modifier l'annonce">
                      <mat-icon>edit</mat-icon>
                      Modifier
                    </button>
                    <button mat-raised-button
                            color="warn"
                            (click)="delete(annonce.idAnnonce)"
                            class="delete-btn"
                            matTooltip="Supprimer l'annonce">
                      <mat-icon>delete</mat-icon>
                      Supprimer
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        </div>

        <!-- Mobile Cards -->
        <div class="mobile-view">
          <div *ngFor="let annonce of dataSource.filteredData" class="annonce-card">
            <div class="card-header">
              <div class="annonce-title-mobile">
                <h4>{{ annonce.titre }}</h4>
                <span class="type-badge" *ngIf="!annonce.media">üìù Texte</span>
              </div>
              <div class="annonce-actions-mobile">
                <button mat-icon-button
                        color="primary"
                        (click)="startEdit(annonce)"
                        matTooltip="Modifier">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button
                        color="warn"
                        (click)="delete(annonce.idAnnonce)"
                        matTooltip="Supprimer">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <div class="card-content">
              <div class="annonce-image-mobile" *ngIf="annonce.media">
                <img [src]="toBase64(annonce.media)"
                     (click)="openImageZoom(toBase64(annonce.media))"
                     class="image-preview"
                     alt="Image annonce" />
                <span class="zoom-hint">üëÜ Cliquer pour zoomer</span>
              </div>

              <div class="annonce-text">
                <p>{{ annonce.texte }}</p>
              </div>
            </div>

            <div class="card-footer">
              <span class="annonce-id">ID: {{ annonce.idAnnonce }}</span>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <mat-paginator [pageSize]="10"
                       [pageSizeOptions]="[5, 10, 25, 50]"
                       showFirstLastButtons
                       [length]="dataSource.filteredData.length"
                       class="custom-paginator">
        </mat-paginator>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!loading && dataSource.filteredData.length === 0">
        <div class="empty-icon">üì¢</div>
        <h4>Aucune annonce trouv√©e</h4>
        <p *ngIf="search">Aucune annonce ne correspond √† votre recherche</p>
        <p *ngIf="!search">Aucune annonce n'a √©t√© cr√©√©e pour le moment</p>
        <button *ngIf="search"
                mat-raised-button
                color="primary"
                (click)="search=''; applySearch()"
                class="retry-btn">
          <mat-icon>refresh</mat-icon>
          R√©initialiser la recherche
        </button>
      </div>
    </mat-card>
  </div>

  <!-- Image Zoom Modal -->
  <div class="image-zoom-overlay" *ngIf="zoomedImage" (click)="closeImageZoom()">
    <div class="image-zoom-container" (click)="$event.stopPropagation()">
      <button mat-icon-button class="close-zoom" (click)="closeImageZoom()">
        <mat-icon>close</mat-icon>
      </button>
      <img [src]="zoomedImage" class="zoomed-image" alt="Image zoom√©e" />
    </div>
  </div>
</div>
